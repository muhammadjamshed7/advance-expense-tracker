<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Finance Tracker & Control</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal
                            600: '#0d9488',
                            700: '#0f766e', // Deep Teal
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        accent: {
                            400: '#fbbf24', // Goldish
                            500: '#f59e0b',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0f766e; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform translate-x-full transition-transform duration-300 bg-white border-l-4 shadow-lg rounded p-4 flex items-center gap-3">
        <i id="toast-icon" class="fas fa-check-circle text-green-500"></i>
        <div>
            <h4 id="toast-title" class="font-bold text-sm">Success</h4>
            <p id="toast-msg" class="text-xs text-gray-600">Action completed.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-brand-700 text-white p-2 rounded-lg">
                    <i class="fas fa-wallet text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-brand-900 tracking-tight hidden sm:block">Advanced Finance Tracker</h1>
                <h1 class="text-xl font-bold text-brand-900 tracking-tight sm:hidden">AFTC</h1>
            </div>

            <div class="flex items-center gap-4">
                <div id="auth-section">
                    <!-- Injected via JS -->
                    <button id="btn-login" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition">
                        <i class="fab fa-google text-red-500"></i> Continue with Google
                    </button>
                    <div id="user-info" class="hidden flex items-center gap-3">
                        <div class="text-right hidden md:block">
                            <p id="user-name" class="text-sm font-bold text-gray-900">Guest User</p>
                            <p id="user-status" class="text-xs text-green-600 flex items-center gap-1 justify-end"><i class="fas fa-cloud"></i> Saved to Database</p>
                        </div>
                        <img id="user-avatar" src="https://ui-avatars.com/api/?name=Guest&background=0F766E&color=fff" class="h-9 w-9 rounded-full border-2 border-brand-100">
                        <button id="btn-logout" class="text-gray-400 hover:text-red-500" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
                <button id="mobile-menu-btn" class="md:hidden text-gray-600 text-xl">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-white w-64 border-r border-gray-200 hidden md:flex flex-col flex-none transition-all">
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="router('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg bg-brand-50 text-brand-700">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </button>
                <button onclick="router('expenses')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fas fa-minus-circle w-5 text-red-400"></i> Expenses
                </button>
                <button onclick="router('income')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fas fa-plus-circle w-5 text-green-400"></i> Income
                </button>
                <button onclick="router('export')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fas fa-file-export w-5 text-blue-400"></i> Export & Data
                </button>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <div class="bg-brand-50 p-4 rounded-xl">
                    <p class="text-xs text-brand-600 font-semibold mb-1">Current Balance</p>
                    <h3 id="sidebar-balance" class="text-xl font-bold text-brand-800">$0.00</h3>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 sm:p-8 relative">
            
            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu" class="absolute top-0 left-0 w-full bg-white shadow-lg z-10 p-4 space-y-2 md:hidden hidden">
                <button onclick="router('dashboard'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50">Dashboard</button>
                <button onclick="router('expenses'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50">Expenses</button>
                <button onclick="router('income'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50">Income</button>
                <button onclick="router('export'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50">Export</button>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="fade-in space-y-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
                    <div class="flex items-center bg-white rounded-lg shadow-sm border border-gray-200 p-1">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded text-gray-500"><i class="fas fa-chevron-left"></i></button>
                        <span id="current-month-display" class="px-4 font-medium text-gray-700 w-32 text-center">Loading...</span>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded text-gray-500"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-green-100 p-3 rounded-full text-green-600"><i class="fas fa-arrow-down"></i></div>
                            <span class="text-xs font-semibold text-gray-400 uppercase">Income</span>
                        </div>
                        <h3 id="dash-income" class="text-2xl font-bold text-gray-900">$0.00</h3>
                        <p class="text-xs text-gray-500 mt-1">This month</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-red-100 p-3 rounded-full text-red-600"><i class="fas fa-arrow-up"></i></div>
                            <span class="text-xs font-semibold text-gray-400 uppercase">Expenses</span>
                        </div>
                        <h3 id="dash-expense" class="text-2xl font-bold text-gray-900">$0.00</h3>
                        <p id="dash-expense-count" class="text-xs text-gray-500 mt-1">0 transactions today</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-wallet"></i></div>
                            <span class="text-xs font-semibold text-gray-400 uppercase">Balance</span>
                        </div>
                        <h3 id="dash-balance" class="text-2xl font-bold text-gray-900">$0.00</h3>
                        <p id="dash-insight" class="text-xs text-brand-600 mt-1 font-medium">Analyzing...</p>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
                        <h3 class="font-bold text-gray-800 mb-4">Monthly Spending Trend</h3>
                        <div class="h-64 relative w-full">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4">Category Breakdown</h3>
                        <div class="h-64 relative w-full flex justify-center">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">Recent Activity</h3>
                        <button onclick="router('expenses')" class="text-sm text-brand-600 hover:underline">View All</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Date</th>
                                    <th class="px-6 py-3 font-medium">Category</th>
                                    <th class="px-6 py-3 font-medium">Note</th>
                                    <th class="px-6 py-3 font-medium text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="recent-transactions-list" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: EXPENSES -->
            <div id="view-expenses" class="hidden fade-in max-w-3xl mx-auto space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Record Expense</h2>
                
                <form id="expense-form" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="exp-date" required class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="exp-amount" min="0.01" step="0.01" required placeholder="0.00" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="exp-category" required class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                                <option value="" disabled selected>Select Category</option>
                                <option value="Mobile Package">Mobile Package</option>
                                <option value="Family Payments">Family Payments</option>
                                <option value="Grocery">Grocery</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Utility Bills">Utility Bills</option>
                                <option value="Transport">Transport</option>
                                <option value="Miscellaneous">Miscellaneous</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>
                            <div id="subcategory-container">
                                <select id="exp-subcategory" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none bg-gray-50" disabled>
                                    <option>Select Main Category First</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                        <textarea id="exp-desc" rows="2" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none"></textarea>
                    </div>

                    <div class="flex items-center gap-3 pt-2">
                        <button type="submit" class="flex-1 bg-brand-600 text-white font-medium py-2.5 rounded-lg hover:bg-brand-700 transition shadow-sm">
                            <i class="fas fa-check mr-2"></i> Save Expense
                        </button>
                        <button type="button" onclick="resetForm('expense-form')" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg border border-gray-200">
                            Clear
                        </button>
                    </div>
                </form>

                <h3 class="text-lg font-bold text-gray-800 mt-8">Expense History (This Month)</h3>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Date</th>
                                    <th class="px-6 py-3 font-medium">Details</th>
                                    <th class="px-6 py-3 font-medium text-right">Amount</th>
                                    <th class="px-6 py-3 font-medium text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="expense-list-table" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: INCOME -->
            <div id="view-income" class="hidden fade-in max-w-3xl mx-auto space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Record Income</h2>
                
                <form id="income-form" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="inc-date" required class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="inc-amount" min="0.01" step="0.01" required placeholder="0.00" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                        <select id="inc-source" required class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">
                            <option value="" disabled selected>Select Source</option>
                            <option value="Salary">Salary</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Business">Business</option>
                            <option value="Gift">Gift</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="inc-note" rows="2" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none"></textarea>
                    </div>

                    <div class="flex items-center gap-3 pt-2">
                        <button type="submit" class="flex-1 bg-green-600 text-white font-medium py-2.5 rounded-lg hover:bg-green-700 transition shadow-sm">
                            <i class="fas fa-check mr-2"></i> Save Income
                        </button>
                    </div>
                </form>

                <h3 class="text-lg font-bold text-gray-800 mt-8">Income History (This Month)</h3>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Date</th>
                                    <th class="px-6 py-3 font-medium">Source</th>
                                    <th class="px-6 py-3 font-medium text-right">Amount</th>
                                    <th class="px-6 py-3 font-medium text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="income-list-table" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: EXPORT & SETTINGS -->
            <div id="view-export" class="hidden fade-in max-w-3xl mx-auto space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Export & Data</h2>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">Export Reports</h3>
                    <p class="text-sm text-gray-500 mb-6">Download your financial data. No data is sent to external email servers.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button onclick="exportData('pdf')" class="flex flex-col items-center justify-center p-6 border-2 border-red-100 rounded-xl hover:bg-red-50 hover:border-red-300 transition group">
                            <i class="fas fa-file-pdf text-3xl text-red-500 mb-3 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-gray-700">Download PDF</span>
                        </button>
                        <button onclick="exportData('csv')" class="flex flex-col items-center justify-center p-6 border-2 border-green-100 rounded-xl hover:bg-green-50 hover:border-green-300 transition group">
                            <i class="fas fa-file-csv text-3xl text-green-500 mb-3 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-gray-700">Download CSV</span>
                        </button>
                        <button onclick="exportData('excel')" class="flex flex-col items-center justify-center p-6 border-2 border-blue-100 rounded-xl hover:bg-blue-50 hover:border-blue-300 transition group">
                            <i class="fas fa-file-excel text-3xl text-blue-500 mb-3 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-gray-700">Download Excel</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 border-l-4 border-l-red-500">
                    <h3 class="font-bold text-red-600 mb-2">Danger Zone</h3>
                    <p class="text-sm text-gray-500 mb-4">Permanently delete all data from this device/account.</p>
                    <button onclick="resetAllData()" class="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 transition text-sm font-medium">
                        Reset All Data
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals or Hidden Inputs for Logic -->
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Globals ---
        // Replacing default config with USER PROVIDED CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDC-2S5ySoG0jfOuyMl93BkFF25JRrIkF8",
            authDomain: "advaceexpense.firebaseapp.com",
            projectId: "advaceexpense",
            storageBucket: "advaceexpense.firebasestorage.app",
            messagingSenderId: "233232869396",
            appId: "1:233232869396:web:293fa94af34b25a00d9f01",
            measurementId: "G-GHN1VZGQGM"
        };
        
        // App ID logic: We use a fixed ID or the project ID to keep collections separated if needed.
        // But since user provided a specific project, we can just use "default" or the project ID as the root path to be safe.
        const appId = "advaceexpense"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let transactions = []; // Main in-memory data store
        let currentMonth = new Date();
        let charts = { bar: null, doughnut: null };

        // --- Category Map ---
        const CATEGORIES = {
            "Mobile Package": ["Prepaid", "Postpaid", "Data Bundle", "Call Package"],
            "Family Payments": ["Family Person", "Mother", "Ali", "Brother", "Custom"],
            "Grocery": ["Vegetables", "Flour/Grains", "Household Items", "Other Grocery", "Custom"],
            "Shopping": ["Clothing", "Electronics", "Gifts", "Custom"],
            "Utility Bills": ["Electricity", "Water", "Gas", "Internet"],
            "Transport": ["Fuel", "Public Transport", "Maintenance", "Ride Hailing"],
            "Miscellaneous": ["Dining Out", "Entertainment", "Health", "Custom"]
        };

        // --- Authentication Logic ---
        const initAuth = async () => {
            try {
                // Try anonymous auth. If it fails (admin restricted), catch it and do nothing
                // (letting the app fall back to localStorage/Guest Mode in onAuthStateChanged).
                await signInAnonymously(auth);
            } catch (err) {
                console.warn("Auth initialization warning:", err.code, err.message);
                if (err.code === 'auth/admin-restricted-operation') {
                    showToast("Guest Mode", "Anonymous login disabled. Using Local Storage.", "info");
                }
            }
        };
        initAuth();

        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const authSection = document.getElementById('auth-section');

        // Handle Login (Upgrade from Anonymous to Google)
        btnLogin.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                if (error.code === 'auth/unauthorized-domain' || error.code === 'auth/cancelled-popup-request') {
                    showToast("Login Unavailable", "Please deploy to Vercel to use Google Login. Database is active in Guest Mode.", "error");
                } else {
                    showToast("Login Failed", error.message, "error");
                }
            }
        });

        // Handle Logout
        btnLogout.addEventListener('click', async () => {
            await signOut(auth);
            // Immediately sign back in anonymously to keep "saving to database" active for guest
            // If that fails, it will just fail silently and stay null (local storage mode)
            try {
                await signInAnonymously(auth);
            } catch(e) {
                console.warn("Re-auth failed", e);
            }
            transactions = [];
            showToast("Logged Out", "Reverted to Guest Mode.");
        });

        // Auth State Listener
        // NOW: EVERY user (Anon or Google) is treated as a Database User
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (user) {
                // We have a user (either Anon or Google)
                // Show User Info in Header
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('btn-login').classList.add('hidden');
                
                if (user.isAnonymous) {
                    document.getElementById('user-name').textContent = "Guest User";
                    document.getElementById('user-status').innerHTML = '<i class="fas fa-cloud"></i> Saved to Database';
                    document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=Guest&background=0F766E&color=fff`;
                } else {
                    document.getElementById('user-name').textContent = user.displayName || "User";
                    document.getElementById('user-status').innerHTML = '<i class="fas fa-check-circle"></i> Google Account';
                    document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=0F766E&color=fff`;
                }

                // Subscribe to Firestore for THIS user
                subscribeToCloudData(user.uid);
            } else {
                // User is null (e.g., Anon auth failed/disabled)
                // Fallback to purely Local Storage Guest Mode
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('btn-login').classList.remove('hidden');
                if (unsubscribeFirestore) unsubscribeFirestore();
                
                // Fallback local storage check
                const raw = localStorage.getItem('financeData');
                transactions = raw ? JSON.parse(raw) : [];
                updateUI();
            }
        });

        // --- Data Management ---

        // Cloud Firestore Listener
        let unsubscribeFirestore = null;

        function subscribeToCloudData(userId) {
            if (unsubscribeFirestore) unsubscribeFirestore();

            // Using 'users' collection directly under the project since user provided custom credentials
            const q = query(collection(db, 'users', userId, 'transactions'));
            
            unsubscribeFirestore = onSnapshot(q, (snapshot) => {
                const cloudData = [];
                snapshot.forEach((doc) => {
                    cloudData.push({ ...doc.data(), id: doc.id });
                });
                transactions = cloudData;
                updateUI();
            }, (error) => {
                console.error("Firestore error:", error);
                if (error.code !== 'permission-denied') {
                    showToast("Sync Error", "Could not fetch cloud data.", "error");
                }
            });
        }

        async function addTransaction(data) {
            // Priority: Save to Cloud if user exists (Anon or Google)
            if (currentUser) {
                try {
                    const ref = collection(db, 'users', currentUser.uid, 'transactions');
                    delete data.id; 
                    await addDoc(ref, data);
                    showToast("Saved", "Transaction saved to Database.");
                } catch (e) {
                    console.error(e);
                    showToast("Error", "Failed to save to database.", "error");
                    // Fallback to local array just to update UI temporarily
                    data.id = "temp_" + Date.now();
                    transactions.push(data);
                    updateUI();
                }
            } else {
                // Extreme fallback
                data.id = crypto.randomUUID();
                transactions.push(data);
                localStorage.setItem('financeData', JSON.stringify(transactions));
                updateUI();
                showToast("Saved", "Saved locally (Auth offline).");
            }
        }

        async function deleteTransaction(id) {
            if (confirm("Are you sure you want to delete this?")) {
                if (currentUser) {
                    try {
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
                        showToast("Deleted", "Removed from Database.");
                    } catch (e) {
                        showToast("Error", "Failed to delete.", "error");
                    }
                } else {
                    transactions = transactions.filter(t => t.id !== id);
                    localStorage.setItem('financeData', JSON.stringify(transactions));
                    updateUI();
                    showToast("Deleted", "Removed locally.");
                }
            }
        }

        // --- UI Logic & Routing ---

        window.router = function(viewName) {
            // Hide all views
            ['dashboard', 'expenses', 'income', 'export'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            // Show selected
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Active Nav State
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.getAttribute('onclick').includes(viewName)) {
                    el.classList.add('bg-brand-50', 'text-brand-700');
                    el.classList.remove('text-gray-600');
                } else {
                    el.classList.remove('bg-brand-50', 'text-brand-700');
                    el.classList.add('text-gray-600');
                }
            });

            if (viewName === 'dashboard') renderDashboard();
        }

        window.toggleMobileMenu = function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        function updateUI() {
            // Determine which view is active and re-render appropriate parts
            if (!document.getElementById('view-dashboard').classList.contains('hidden')) renderDashboard();
            if (!document.getElementById('view-expenses').classList.contains('hidden')) renderLists();
            if (!document.getElementById('view-income').classList.contains('hidden')) renderLists();
        }

        // --- Dashboard & Charts ---

        window.changeMonth = function(offset) {
            currentMonth.setMonth(currentMonth.getMonth() + offset);
            renderDashboard();
        }

        function renderDashboard() {
            // 1. Date Header
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-display').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

            // 2. Filter Data for Month
            const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0); // Last day
            
            const monthData = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= start && tDate <= end;
            });

            // 3. Calcs
            let income = 0;
            let expense = 0;
            const expenseCats = {};
            let todaysCount = 0;
            const todayStr = new Date().toISOString().split('T')[0];

            monthData.forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.type === 'income') {
                    income += amt;
                } else {
                    expense += amt;
                    expenseCats[t.category] = (expenseCats[t.category] || 0) + amt;
                    if (t.date === todayStr) todaysCount++;
                }
            });

            const net = income - expense;

            // 4. Update DOM Stats
            document.getElementById('dash-income').textContent = `$${income.toFixed(2)}`;
            document.getElementById('dash-expense').textContent = `$${expense.toFixed(2)}`;
            document.getElementById('dash-balance').textContent = `$${net.toFixed(2)}`;
            document.getElementById('sidebar-balance').textContent = `$${net.toFixed(2)}`;
            
            // Dynamic Insight
            const elInsight = document.getElementById('dash-insight');
            if (net < 0) { elInsight.textContent = "You're spending more than you earn."; elInsight.className="text-xs text-red-500 mt-1 font-medium"; }
            else if (net > 0) { elInsight.textContent = "Great job saving this month!"; elInsight.className="text-xs text-green-500 mt-1 font-medium"; }
            else { elInsight.textContent = "Balanced budget."; elInsight.className="text-xs text-gray-500 mt-1 font-medium"; }
            
            document.getElementById('dash-expense-count').textContent = `${todaysCount} transactions today`;

            // 5. Update Charts
            updateCharts(expenseCats, monthData);

            // 6. Recent List
            const sorted = [...monthData].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const listEl = document.getElementById('recent-transactions-list');
            listEl.innerHTML = sorted.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">${t.date}</td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900">${t.type === 'income' ? t.source : t.category}</span>
                        <div class="text-xs text-gray-500">${t.type === 'income' ? '' : t.subcategory || ''}</div>
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-500">${t.note || t.description || '-'}</td>
                    <td class="px-6 py-4 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'}$${parseFloat(t.amount).toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        function updateCharts(categoryData, allMonthData) {
            // Destroy old charts if exist
            if (charts.bar) charts.bar.destroy();
            if (charts.doughnut) charts.doughnut.destroy();

            // Doughnut (Categories)
            const catLabels = Object.keys(categoryData);
            const catValues = Object.values(categoryData);
            const colors = ['#14b8a6', '#f59e0b', '#0ea5e9', '#6366f1', '#ec4899', '#8b5cf6', '#ef4444'];

            const ctxD = document.getElementById('doughnutChart').getContext('2d');
            charts.doughnut = new Chart(ctxD, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catValues,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } }
                    }
                }
            });

            // Bar (Income vs Expense Daily optional, or just Total comparison)
            // Let's do Daily Expense Trend
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const dailyExp = new Array(daysInMonth).fill(0);
            
            allMonthData.forEach(t => {
                if(t.type === 'expense') {
                    const d = new Date(t.date).getDate();
                    dailyExp[d-1] += parseFloat(t.amount);
                }
            });

            const ctxB = document.getElementById('barChart').getContext('2d');
            charts.bar = new Chart(ctxB, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Daily Expenses',
                        data: dailyExp,
                        backgroundColor: '#14b8a6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- Form Handling & Lists ---

        // Populate Subcategories
        const catSelect = document.getElementById('exp-category');
        const subContainer = document.getElementById('subcategory-container');
        
        catSelect.addEventListener('change', (e) => {
            const main = e.target.value;
            const subs = CATEGORIES[main];
            
            let html = `<select id="exp-subcategory" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none">`;
            subs.forEach(s => html += `<option value="${s}">${s}</option>`);
            html += `</select>`;
            
            subContainer.innerHTML = html;

            // Handle "Custom" in the new dropdown
            const subSelect = document.getElementById('exp-subcategory');
            subSelect.addEventListener('change', (ev) => {
                if (ev.target.value === 'Custom') {
                    subContainer.innerHTML = `<input type="text" id="exp-subcategory" placeholder="Type custom subcategory" class="w-full border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500 border p-2.5 outline-none" autofocus>`;
                }
            });
        });

        // Add Expense
        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const subVal = document.getElementById('exp-subcategory').value;
            
            const data = {
                type: 'expense',
                date: document.getElementById('exp-date').value,
                amount: parseFloat(document.getElementById('exp-amount').value),
                category: document.getElementById('exp-category').value,
                subcategory: subVal,
                description: document.getElementById('exp-desc').value,
                timestamp: Date.now()
            };

            await addTransaction(data);
            e.target.reset();
            document.getElementById('exp-date').valueAsDate = new Date(); // Reset date to today
            renderLists();
        });

        // Add Income
        document.getElementById('income-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                type: 'income',
                date: document.getElementById('inc-date').value,
                amount: parseFloat(document.getElementById('inc-amount').value),
                source: document.getElementById('inc-source').value,
                note: document.getElementById('inc-note').value,
                timestamp: Date.now()
            };

            await addTransaction(data);
            e.target.reset();
            document.getElementById('inc-date').valueAsDate = new Date();
            renderLists();
        });

        window.renderLists = function() {
            // Render Expense Table (Current Month)
            const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            const monthData = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= start && tDate <= end;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            // Expense List
            const expList = document.getElementById('expense-list-table');
            expList.innerHTML = monthData.filter(t => t.type === 'expense').map(t => `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-6 py-4">${t.date}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${t.category}</div>
                        <div class="text-xs text-gray-500">${t.subcategory} ${t.description ? '- ' + t.description : ''}</div>
                    </td>
                    <td class="px-6 py-4 text-right font-bold text-gray-700">$${parseFloat(t.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="window.deleteTx('${t.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Income List
            const incList = document.getElementById('income-list-table');
            incList.innerHTML = monthData.filter(t => t.type === 'income').map(t => `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-6 py-4">${t.date}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${t.source}</div>
                        <div class="text-xs text-gray-500">${t.note || ''}</div>
                    </td>
                    <td class="px-6 py-4 text-right font-bold text-green-600">$${parseFloat(t.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="window.deleteTx('${t.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Expose delete to global scope
        window.deleteTx = (id) => deleteTransaction(id);

        window.resetForm = function(id) {
            document.getElementById(id).reset();
        }

        // --- Export Logic ---
        window.exportData = function(format) {
            if (transactions.length === 0) {
                showToast("Empty", "No data to export.", "error");
                return;
            }

            if (format === 'excel' || format === 'csv') {
                const ws = XLSX.utils.json_to_sheet(transactions);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "FinanceData");
                const ext = format === 'excel' ? 'xlsx' : 'csv';
                XLSX.writeFile(wb, `Finance_Report.${ext}`);
                showToast("Downloaded", `File exported as ${ext.toUpperCase()}`);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Finance Report", 14, 22);
                doc.setFontSize(11);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);

                const tableColumn = ["Date", "Type", "Category/Source", "Amount", "Note"];
                const tableRows = [];

                transactions.forEach(t => {
                    const reportData = [
                        t.date,
                        t.type.toUpperCase(),
                        t.type === 'income' ? t.source : t.category,
                        `$${t.amount}`,
                        t.type === 'income' ? t.note : t.description
                    ];
                    tableRows.push(reportData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                });

                doc.save('Finance_Report.pdf');
                showToast("Downloaded", "File exported as PDF");
            }
        }

        window.resetAllData = function() {
            if(confirm("CRITICAL WARNING: This will permanently delete ALL your data. Are you sure?")) {
                if(currentUser) {
                     // In a real app we would use a Batch delete or cloud function.
                     // Here we alert the user as client-side mass deletion of subcollections is heavy.
                     // But for this simple list, we can iterate:
                     transactions.forEach(t => deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', t.id)));
                     showToast("Clearing...", "Deleting records from database...");
                } else {
                    transactions = [];
                    localStorage.removeItem('financeData');
                    location.reload();
                }
            }
        }

        // --- Utilities ---
        function showToast(title, msg, type="success") {
            const el = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-msg').textContent = msg;
            
            if (type === 'error') {
                icon.className = "fas fa-exclamation-circle text-red-500";
            } else {
                icon.className = "fas fa-check-circle text-green-500";
            }

            el.classList.remove('translate-x-full');
            setTimeout(() => {
                el.classList.add('translate-x-full');
            }, 3000);
        }

        // --- Init Defaults ---
        document.getElementById('exp-date').valueAsDate = new Date();
        document.getElementById('inc-date').valueAsDate = new Date();
        
        // Initial Render
        renderDashboard();

    </script>
</body>
</html>
